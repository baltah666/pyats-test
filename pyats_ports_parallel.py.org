#!/usr/bin/env python3

import time
from pyats.topology import loader
from pyats.async_ import pcall
import pandas as pd
from tabulate import tabulate

TESTBED_FILE = "testbed.yaml"
OUTPUT_EXCEL = "pyats_device_ports_status.xlsx"

MEDIA_COLUMNS = [
    "10/100BaseTX",
    "10/100/1000BaseTX",
    "1000BaseLX SFP",
]

STATUS_WORDS = {
    "connected",
    "notconnect",
    "disabled",
    "err-disabled",
    "inactive",
}

def parse_interfaces(output):
    total_ports = 0
    active_ports = 0
    media_counts = {m: 0 for m in MEDIA_COLUMNS}

    for raw in output.splitlines():
        line = raw.strip()

        if not line or line.startswith("Port"):
            continue

        if not line.startswith(("Fa", "Gi", "Te", "Po")):
            continue

        parts = line.split()

        status_idx = None
        for i, p in enumerate(parts):
            if p in STATUS_WORDS:
                status_idx = i
                break

        if status_idx is None or len(parts) < status_idx + 5:
            continue

        status = parts[status_idx]
        port_type = " ".join(parts[status_idx + 4:])

        total_ports += 1

        if status == "connected":
            active_ports += 1
            for media in MEDIA_COLUMNS:
                if media in port_type:
                    media_counts[media] += 1

    return total_ports, active_ports, media_counts


def pct(active, total):
    return round((active / total) * 100, 2) if total else 0


def process_device(device):
    row = {
        "Hostname": device.name,
        "Total Ports": 0,
        "Active Ports": 0,
        "Port Utilization %": 0,
    }
    for m in MEDIA_COLUMNS:
        row[m] = 0

    try:
        print(f"ðŸ” Connecting to {device.name} ...")

        device.connect(
            via="cli",
            log_stdout=False,
            learn_hostname=False,
            learn_os=False,
            init_exec_commands=[],
            init_config_commands=[],
            timeout=60
        )

        output = device.execute("show interfaces status")

        total, active, media = parse_interfaces(output)

        row["Total Ports"] = total
        row["Active Ports"] = active
        row["Port Utilization %"] = pct(active, total)

        for m in MEDIA_COLUMNS:
            row[m] = media[m]

        device.disconnect()

    except Exception as e:
        print(f"âŒ Failed on {device.name}: {e}")

    return row


def main():
    print("\nðŸ“¦ Loading testbed...")
    testbed = loader.load(TESTBED_FILE)

    devices = [
        d for d in testbed.devices.values()
        if d.os in ("ios", "iosxe")
    ]

    print(f"\nðŸš€ Running pyATS parallel execution for {len(devices)} devices\n")

    start = time.time()

    results = pcall(process_device, device=devices)

    elapsed = round(time.time() - start, 2)

    df = pd.DataFrame(results)

    print("\nðŸ“Š pyATS Port Utilization Summary\n")
    print(tabulate(df, headers="keys", tablefmt="grid", showindex=False))

    df.to_excel(OUTPUT_EXCEL, index=False)

    print(f"\nâœ… Results saved to {OUTPUT_EXCEL}")
    print(f"â± Execution time: {elapsed} seconds")


if __name__ == "__main__":
    main()
